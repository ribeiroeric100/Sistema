<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odontograma (Demo) — odonto-app</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;

      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --neutral: #9ca3af;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.35;
    }

    header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--card);
    }
    header h1 { margin: 0 0 6px; font-size: 18px; }
    header p { margin: 0; color: var(--muted); font-size: 13px; }

    .wrap {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 16px;
      padding: 16px;
      align-items: start;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .panel .hd {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: #f9fafb;
      font-weight: 700;
      font-size: 14px;
    }

    .panel .bd { padding: 14px; }

    .odontogram {
      padding: 14px;
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: #ffffff;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--neutral);
      border: 1px solid rgba(0,0,0,0.08);
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .archLabel { color: var(--muted); font-size: 12px; margin: 0 0 6px; }

    .teethRow {
      display: grid;
      grid-template-columns: repeat(16, minmax(0, 1fr));
      gap: 8px;
    }

    .tooth {
      position: relative;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 8px;
      cursor: pointer;
      min-width: 0;
      outline: none;
      user-select: none;
    }

    .tooth:focus-visible {
      box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
      border-color: rgba(59,130,246,0.8);
    }

    .tooth .num { font-weight: 800; font-size: 13px; }
    .tooth .faces { margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }

    .face {
      height: 9px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.06);
      background: #f3f4f6;
    }

    .tooth[data-cond="saudavel"] { border-color: rgba(16,185,129,0.55); }
    .tooth[data-cond="carie"] { border-color: rgba(239,68,68,0.65); }
    .tooth[data-cond="restauracao"] { border-color: rgba(59,130,246,0.65); }
    .tooth[data-cond="tratamento"] { border-color: rgba(245,158,11,0.7); }
    .tooth[data-cond="ausente"] { border-color: rgba(156,163,175,0.8); background: #f9fafb; }

    .tooth[data-cond="saudavel"] .num { color: var(--ok); }
    .tooth[data-cond="carie"] .num { color: var(--danger); }
    .tooth[data-cond="restauracao"] .num { color: var(--info); }
    .tooth[data-cond="tratamento"] .num { color: var(--warn); }
    .tooth[data-cond="ausente"] .num { color: var(--neutral); text-decoration: line-through; }

    .tooth[data-selected="1"] {
      box-shadow: 0 0 0 3px rgba(17,24,39,0.08);
      border-color: rgba(17,24,39,0.35);
    }

    .row {
      display: grid;
      gap: 6px;
      margin-bottom: 12px;
    }

    label { font-size: 12px; color: var(--muted); }

    select, textarea, input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    textarea { min-height: 90px; resize: vertical; }

    .facesPick {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .chip {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      text-align: center;
      cursor: pointer;
      font-weight: 700;
      color: #374151;
      background: #fff;
      user-select: none;
    }

    .chip[data-on="1"] { border-color: rgba(59,130,246,0.55); background: rgba(59,130,246,0.08); }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      color: #111827;
    }

    button.primary {
      background: #111827;
      border-color: #111827;
      color: #fff;
    }

    pre {
      margin: 0;
      padding: 10px;
      background: #0b1020;
      color: #e5e7eb;
      border-radius: 10px;
      overflow: auto;
      font-size: 12px;
    }

    .hint { color: var(--muted); font-size: 12px; }

    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Odontograma (Demo) — visão básica para prontuário</h1>
    <p>
      Clique em um dente para marcar condição, faces e observação.
      Isso é um exemplo de como eu estruturaria o odontograma no sistema (clínica pequena).
    </p>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="hd">Odontograma</div>
      <div class="odontogram">
        <div class="grid">
          <div>
            <p class="archLabel">Arcada Superior (FDI: 18 → 11 | 21 → 28)</p>
            <div class="teethRow" id="upperRow"></div>
          </div>

          <div>
            <p class="archLabel">Arcada Inferior (FDI: 48 → 41 | 31 → 38)</p>
            <div class="teethRow" id="lowerRow"></div>
          </div>
        </div>
      </div>

      <div class="legend" aria-label="Legenda">
        <span class="pill"><span class="dot" style="background: var(--ok)"></span> Saudável</span>
        <span class="pill"><span class="dot" style="background: var(--danger)"></span> Cárie</span>
        <span class="pill"><span class="dot" style="background: var(--info)"></span> Restauração</span>
        <span class="pill"><span class="dot" style="background: var(--warn)"></span> Em tratamento</span>
        <span class="pill"><span class="dot" style="background: var(--neutral)"></span> Ausente</span>
      </div>
    </section>

    <aside class="panel" aria-label="Editor do dente">
      <div class="hd">Editor</div>
      <div class="bd">
        <div class="row">
          <label>Dente selecionado</label>
          <input id="selectedTooth" type="text" value="(clique em um dente)" disabled />
        </div>

        <div class="row">
          <label>Condição</label>
          <select id="condSelect" disabled>
            <option value="saudavel">Saudável</option>
            <option value="carie">Cárie</option>
            <option value="restauracao">Restauração</option>
            <option value="tratamento">Em tratamento</option>
            <option value="ausente">Ausente</option>
          </select>
        </div>

        <div class="row">
          <label>Faces (opcional)</label>
          <div class="facesPick" id="facesPick" aria-label="Faces do dente">
            <div class="chip" data-face="V" data-on="0">V</div>
            <div class="chip" data-face="M" data-on="0">M</div>
            <div class="chip" data-face="O" data-on="0">O</div>
            <div class="chip" data-face="D" data-on="0">D</div>
            <div class="chip" data-face="L" data-on="0">L</div>
          </div>
          <div class="hint">V=Vestibular, L=Lingual, O=Oclusal, M=Mesial, D=Distal.</div>
        </div>

        <div class="row">
          <label>Observação (opcional)</label>
          <textarea id="note" placeholder="Ex.: Sensibilidade, fratura, etc." disabled></textarea>
        </div>

        <div class="actions">
          <button class="primary" id="saveBtn" disabled>Salvar no odontograma</button>
          <button id="clearToothBtn" disabled>Limpar dente</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--border); margin: 14px 0;" />

        <div class="row">
          <label>Exportar estado (JSON)</label>
          <div class="actions" style="margin-bottom: 10px;">
            <button id="exportBtn">Exportar</button>
            <button id="importBtn">Importar</button>
            <button id="resetAllBtn">Resetar tudo</button>
          </div>
          <pre id="jsonOut" aria-label="JSON do odontograma">{}</pre>
          <div class="hint" style="margin-top: 8px;">
            No sistema real, esse JSON iria para o banco por paciente (ex.: tabela odontograma_state) e poderia ter histórico (odontograma_events).
          </div>
        </div>

        <hr style="border:0;border-top:1px solid var(--border); margin: 14px 0;" />

        <div class="row">
          <label>Como isso seria usado no seu sistema</label>
          <div class="hint">
            <strong>Fluxo sugerido:</strong><br/>
            1) No <em>PacientePerfil → Prontuário</em>, adicionar uma aba “Odontograma”.<br/>
            2) O odontograma carrega o estado do paciente (GET) e salva alterações (POST/PUT).<br/>
            3) Em cada consulta, dá para registrar “evento” (ex.: restauração no dente 16) e refletir no estado atual.<br/>
            <br/>
            <strong>Modelo de dados mínimo (por paciente):</strong><br/>
            <code>{ toothId: { condition, faces, note, updatedAt } }</code>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    const TOOTH_IDS_UPPER = [18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28];
    const TOOTH_IDS_LOWER = [48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38];

    const STORAGE_KEY = 'odontograma_demo_state_v1';

    const DEFAULT_ENTRY = () => ({
      condition: 'saudavel',
      faces: [],
      note: '',
      updatedAt: new Date().toISOString()
    });

    /**
     * state format:
     * {
     *   "11": { condition: "carie", faces:["O"], note:"...", updatedAt:"..." },
     *   "12": {...}
     * }
     */
    let state = loadState();
    let selected = null;

    const upperRow = document.getElementById('upperRow');
    const lowerRow = document.getElementById('lowerRow');

    const selectedToothEl = document.getElementById('selectedTooth');
    const condSelect = document.getElementById('condSelect');
    const noteEl = document.getElementById('note');
    const saveBtn = document.getElementById('saveBtn');
    const clearToothBtn = document.getElementById('clearToothBtn');

    const facesPick = document.getElementById('facesPick');
    const jsonOut = document.getElementById('jsonOut');

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch (e) {
        return {};
      }
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function renderJson() {
      jsonOut.textContent = JSON.stringify(state, null, 2);
    }

    function createToothCard(toothId) {
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'tooth';
      el.setAttribute('data-tooth', String(toothId));

      const entry = state[String(toothId)] || DEFAULT_ENTRY();
      el.setAttribute('data-cond', entry.condition);
      el.setAttribute('data-selected', '0');

      el.innerHTML = `
        <div class="num">${toothId}</div>
        <div class="faces" aria-hidden="true">
          <div class="face"></div><div class="face"></div><div class="face"></div>
          <div class="face"></div><div class="face"></div><div class="face"></div>
        </div>
      `;

      el.addEventListener('click', () => selectTooth(toothId));
      return el;
    }

    function renderRows() {
      upperRow.innerHTML = '';
      lowerRow.innerHTML = '';
      TOOTH_IDS_UPPER.forEach(id => upperRow.appendChild(createToothCard(id)));
      TOOTH_IDS_LOWER.forEach(id => lowerRow.appendChild(createToothCard(id)));
      syncSelectionStyles();
    }

    function syncSelectionStyles() {
      const all = document.querySelectorAll('.tooth');
      all.forEach(btn => {
        const tid = btn.getAttribute('data-tooth');
        btn.setAttribute('data-selected', selected && String(selected) === tid ? '1' : '0');

        const entry = state[tid] || DEFAULT_ENTRY();
        btn.setAttribute('data-cond', entry.condition);
      });
    }

    function setEditorEnabled(on) {
      condSelect.disabled = !on;
      noteEl.disabled = !on;
      saveBtn.disabled = !on;
      clearToothBtn.disabled = !on;
      const chips = facesPick.querySelectorAll('.chip');
      chips.forEach(c => c.style.pointerEvents = on ? 'auto' : 'none');
      chips.forEach(c => c.style.opacity = on ? '1' : '0.6');
    }

    function setFacesUI(faces) {
      const set = new Set(faces || []);
      facesPick.querySelectorAll('.chip').forEach(chip => {
        const face = chip.getAttribute('data-face');
        chip.setAttribute('data-on', set.has(face) ? '1' : '0');
      });
    }

    function getFacesFromUI() {
      const faces = [];
      facesPick.querySelectorAll('.chip').forEach(chip => {
        if (chip.getAttribute('data-on') === '1') faces.push(chip.getAttribute('data-face'));
      });
      return faces;
    }

    function selectTooth(toothId) {
      selected = toothId;
      selectedToothEl.value = String(toothId);
      setEditorEnabled(true);

      const entry = state[String(toothId)] || DEFAULT_ENTRY();
      condSelect.value = entry.condition;
      noteEl.value = entry.note || '';
      setFacesUI(entry.faces || []);

      syncSelectionStyles();
    }

    facesPick.addEventListener('click', (e) => {
      const el = e.target;
      if (!el || !el.classList.contains('chip')) return;
      if (!selected) return;
      const on = el.getAttribute('data-on') === '1';
      el.setAttribute('data-on', on ? '0' : '1');
    });

    saveBtn.addEventListener('click', () => {
      if (!selected) return;
      const toothKey = String(selected);
      state[toothKey] = {
        condition: condSelect.value,
        faces: getFacesFromUI(),
        note: noteEl.value || '',
        updatedAt: new Date().toISOString()
      };
      persist();
      renderJson();
      syncSelectionStyles();
    });

    clearToothBtn.addEventListener('click', () => {
      if (!selected) return;
      const toothKey = String(selected);
      delete state[toothKey];
      persist();
      renderJson();
      syncSelectionStyles();

      // Keep selection, but reset editor to defaults
      const entry = DEFAULT_ENTRY();
      condSelect.value = entry.condition;
      noteEl.value = entry.note;
      setFacesUI(entry.faces);
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      renderJson();
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      const raw = prompt('Cole aqui o JSON do odontograma:');
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') throw new Error('Formato inválido');
        state = parsed;
        persist();
        renderRows();
        renderJson();
        alert('Importado com sucesso.');
      } catch (e) {
        alert('JSON inválido: ' + (e.message || e));
      }
    });

    document.getElementById('resetAllBtn').addEventListener('click', () => {
      if (!confirm('Resetar todo o odontograma desta demo?')) return;
      state = {};
      persist();
      selected = null;
      selectedToothEl.value = '(clique em um dente)';
      setEditorEnabled(false);
      setFacesUI([]);
      noteEl.value = '';
      condSelect.value = 'saudavel';
      renderRows();
      renderJson();
    });

    // init
    setEditorEnabled(false);
    renderRows();
    renderJson();
  </script>
</body>
</html>
